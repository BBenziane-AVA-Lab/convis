<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>convis.filters.retina &mdash; convis 0.1 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="convis 0.1 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">convis 0.1 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for convis.filters.retina</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">litus</span>
<span class="kn">import</span> <span class="nn">theano</span>
<span class="kn">import</span> <span class="nn">theano.tensor</span> <span class="kn">as</span> <span class="nn">T</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pylab</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">..theano_utils</span> <span class="kn">import</span> <span class="n">conv3d</span><span class="p">,</span> <span class="n">conv2d</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">from</span> <span class="nn">exceptions</span> <span class="kn">import</span> <span class="ne">NotImplementedError</span>

<span class="kn">from</span> <span class="nn">..base</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">..theano_utils</span> <span class="kn">import</span> <span class="n">make_nd</span><span class="p">,</span> <span class="n">dtensor5</span><span class="p">,</span> <span class="n">pad5</span><span class="p">,</span> <span class="n">pad5_txy</span><span class="p">,</span> <span class="n">pad2_xy</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">retina_base</span>
<span class="kn">from</span> <span class="nn">..numerical_filters</span> <span class="kn">import</span> <span class="n">conv</span><span class="p">,</span> <span class="n">fake_filter</span><span class="p">,</span> <span class="n">fake_filter_shape</span>
<span class="kn">from</span> <span class="nn">..numerical_filters</span> <span class="kn">import</span> <span class="n">exponential_filter_1d</span><span class="p">,</span> <span class="n">exponential_filter_5d</span><span class="p">,</span> <span class="n">exponential_highpass_filter_1d</span><span class="p">,</span> <span class="n">exponential_highpass_filter_5d</span>
<span class="kn">from</span> <span class="nn">..numerical_filters</span> <span class="kn">import</span> <span class="n">gauss_filter_2d</span><span class="p">,</span> <span class="n">gauss_filter_5d</span>

<div class="viewcode-block" id="OPLLayerNode"><a class="viewcode-back" href="../../../retina.html#convis.filters.retina.OPLLayerNode">[docs]</a><span class="k">class</span> <span class="nc">OPLLayerNode</span><span class="p">(</span><span class="n">Layer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The OPL current is a filtered version of the luminance input with spatial and temporal kernels.</span>

<span class="sd">    $$I_{OLP}(x,y,t) = \lambda_{OPL}(C(x,y,t) - w_{OPL} S(x,y,t)_)$$</span>

<span class="sd">    with:</span>

<span class="sd">    :math:`C(x,y,t) = G * T(wu,Tu) * E(n,t) * L (x,y,t)`</span>

<span class="sd">    :math:`S(x,y,t) = G * E * C(x,y,t)`</span>

<span class="sd">    In the case of leaky heat equation:</span>

<span class="sd">    :math:`C(x,y,t) = T(wu,Tu) * K(sigma_C,Tau_C) * L (x,y,t)`</span>

<span class="sd">    :math:`S(x,y,t) = K(sigma_S,Tau_S) * C(x,y,t)`</span>
<span class="sd">    p.275</span>

<span class="sd">    To keep all dimensions similar, a *fake kernel* has to be used on the center output that contains a single 1 but has the shape of the filters used on the surround, such that the surround can be subtracted from the center.</span>

<span class="sd">    The inputs of the function are: </span>

<span class="sd">     * :py:obj:`L` (the luminance input), </span>
<span class="sd">     * :py:obj:`E_n_C`, :py:obj:`TwuTu_C`, :py:obj:`G_C` (the center filters), </span>
<span class="sd">     * :py:obj:`E_S`, :py:obj:`G_S` (the surround filters), </span>
<span class="sd">     * :py:obj:`Reshape_C_S` (the fake filter), </span>
<span class="sd">     * :py:obj:`lambda_OPL`, :py:obj:`w_OPL` (scaling and weight parameters)</span>

<span class="sd">    Since we want to have some temporal and some spatial convolutions (some 1d, some 2d, but orthogonal to each other), we have to use 3d convolution (we don&#39;t have to, but this way we never have to worry about which is which axis). 3d convolution uses 5-tensors (see: &lt;a href=&quot;http://deeplearning.net/software/theano/library/tensor/nnet/conv.html#theano.tensor.nnet.conv3d2d.conv3d&quot;&gt;theano.tensor.nnet.conv&lt;/a&gt;), so we define all inputs, kernels and outputs to be 5-tensors with the unused dimensions (color channels and batch/kernel number) set to be length 1.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">model</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="p">{},</span><span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">input_variable</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">inputs</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">retina</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_variable</span> <span class="o">=</span> <span class="n">make_nd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">create_input</span><span class="p">(),</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_E_n_C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_parameter</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">exponential_filter_5d</span><span class="p">(</span><span class="n">tau</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;center-tau__sec&#39;</span><span class="p">,</span><span class="mf">0.01</span><span class="p">,</span><span class="nb">float</span><span class="p">)),</span>
                                            <span class="n">n</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;center-n__uint&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">)),</span>
                                            <span class="n">resolution</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">resolution</span><span class="p">),</span>
                        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;E_n_C&#39;</span><span class="p">,</span>
                        <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;The n-fold cascaded exponential creates a low-pass characteristic. A filter can be created with `numeric_filters.exponential_filter_5d`&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_TwuTu_C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_parameter</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">exponential_highpass_filter_5d</span><span class="p">(</span><span class="n">tau</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;undershoot&#39;</span><span class="p">,{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tau__sec&#39;</span><span class="p">,</span><span class="mf">0.01</span><span class="p">)),</span>
                                                     <span class="n">relative_weight</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;undershoot&#39;</span><span class="p">,{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;relative-weight&#39;</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">)),</span>
                                                     <span class="n">resolution</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">resolution</span><span class="p">),</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;TwuTu_C&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_G_C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_parameter</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">gauss_filter_5d</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;center-sigma__deg&#39;</span><span class="p">,</span><span class="mf">0.05</span><span class="p">)),</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;center-sigma__deg&#39;</span><span class="p">,</span><span class="mf">0.05</span><span class="p">)),</span>
                                      <span class="n">resolution</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">resolution</span><span class="p">,</span><span class="n">even</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;G_C&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_E_S</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_parameter</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">exponential_filter_5d</span><span class="p">(</span><span class="n">tau</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;surround-tau__sec&#39;</span><span class="p">,</span><span class="mf">0.004</span><span class="p">)),</span><span class="n">resolution</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">resolution</span><span class="p">),</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;E_S&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_G_S</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_parameter</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">gauss_filter_5d</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;surround-sigma__deg&#39;</span><span class="p">,</span><span class="mf">0.15</span><span class="p">)),</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;surround-sigma__deg&#39;</span><span class="p">,</span><span class="mf">0.15</span><span class="p">)),</span>
                                      <span class="n">resolution</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">resolution</span><span class="p">,</span><span class="n">even</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;G_S&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lambda_OPL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_parameter</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">value_from_config</span><span class="p">())</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">resolution</span><span class="o">.</span><span class="n">input_luminosity_range</span><span class="p">),</span>
                <span class="n">save</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">value_to_config</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">resolution</span><span class="o">.</span><span class="n">input_luminosity_range</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">get_value</span><span class="p">()))),</span>
                <span class="n">get</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">resolution</span><span class="o">.</span><span class="n">input_luminosity_range</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">get_value</span><span class="p">())),</span>
                <span class="n">config_key</span> <span class="o">=</span> <span class="s1">&#39;opl-amplification&#39;</span><span class="p">,</span>
                <span class="n">config_default</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;lambda_OPL&#39;</span><span class="p">,</span>
                <span class="n">doc</span><span class="o">=</span><span class="s1">&#39;Gain applied to the OPL signal.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_w_OPL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_parameter</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;opl-relative-weight&#39;</span><span class="p">,</span><span class="mf">1.0</span><span class="p">,</span><span class="nb">float</span><span class="p">),</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;w_OPL&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_Reshape_C_S</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_parameter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">fake_filter</span><span class="p">(</span><span class="n">get_convis_attribute</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">_G_S</span><span class="p">,</span><span class="s1">&#39;update&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">get_value</span><span class="p">(),</span>
                                                                        <span class="n">get_convis_attribute</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">_E_S</span><span class="p">,</span><span class="s1">&#39;update&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">get_value</span><span class="p">()),</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Reshape_C_S&#39;</span><span class="p">,</span>
                                                  <span class="n">doc</span><span class="o">=</span><span class="s1">&#39;This filter resizes C such that the output has the same size as S.&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_input_init</span> <span class="o">=</span> <span class="n">as_state</span><span class="p">(</span><span class="n">dtensor5</span><span class="p">(</span><span class="s1">&#39;input_init&#39;</span><span class="p">),</span>
                                    <span class="n">init</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">get_convis_attribute</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">_E_n_C</span><span class="p">,</span><span class="s1">&#39;update&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span>
                                                    <span class="n">get_convis_attribute</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">_TwuTu_C</span><span class="p">,</span><span class="s1">&#39;update&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span>
                                                    <span class="n">get_convis_attribute</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">_Reshape_C_S</span><span class="p">,</span><span class="s1">&#39;update&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                                    <span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span>
        <span class="n">input_padded_in_time</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_input_init</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">input_variable</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Nx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_G_C</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_G_S</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">Ny</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_G_C</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_G_S</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_L</span> <span class="o">=</span> <span class="n">as_variable</span><span class="p">(</span><span class="n">pad5</span><span class="p">(</span><span class="n">pad5</span><span class="p">(</span><span class="n">input_padded_in_time</span><span class="p">,</span><span class="n">Nx</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">Ny</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="s1">&#39;L&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_C</span> <span class="o">=</span> <span class="n">GraphWrapper</span><span class="p">(</span><span class="n">as_variable</span><span class="p">(</span><span class="n">conv3d</span><span class="p">(</span><span class="n">conv3d</span><span class="p">(</span><span class="n">conv3d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_L</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_E_n_C</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">_TwuTu_C</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">_G_C</span><span class="p">),</span><span class="s1">&#39;C&#39;</span><span class="p">),</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="n">ignore</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_L</span><span class="p">])</span><span class="o">.</span><span class="n">graph</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_S</span> <span class="o">=</span> <span class="n">GraphWrapper</span><span class="p">(</span><span class="n">as_variable</span><span class="p">(</span><span class="n">conv3d</span><span class="p">(</span><span class="n">conv3d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_C</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_E_S</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">_G_S</span><span class="p">),</span><span class="s1">&#39;S&#39;</span><span class="p">),</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;surround&#39;</span><span class="p">,</span><span class="n">ignore</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_C</span><span class="p">])</span><span class="o">.</span><span class="n">graph</span>
        <span class="n">I_OPL</span> <span class="o">=</span> <span class="n">as_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lambda_OPL</span> <span class="o">*</span> <span class="p">(</span><span class="n">conv3d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_C</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_Reshape_C_S</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_w_OPL</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_S</span><span class="p">),</span><span class="s1">&#39;I_OPL&#39;</span><span class="p">,</span><span class="n">html_name</span><span class="o">=</span><span class="s2">&quot;I&lt;sub&gt;OPL&lt;/sub&gt;&quot;</span><span class="p">,</span><span class="n">html_formula</span><span class="o">=</span><span class="s2">&quot;I&lt;sub&gt;OPL&lt;/sub&gt; = &amp;lambda;*(C-w*S)&quot;</span><span class="p">)</span>

        <span class="n">length_of_filters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_E_n_C</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_TwuTu_C</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_Reshape_C_S</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span> 
        <span class="n">as_out_state</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">set_subtensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_init</span><span class="p">[:,</span><span class="o">-</span><span class="p">(</span><span class="n">input_padded_in_time</span><span class="p">[:,</span><span class="o">-</span><span class="p">(</span><span class="n">length_of_filters</span><span class="p">):,:,:,:]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):,:,:,:],</span>
                                    <span class="n">input_padded_in_time</span><span class="p">[:,</span><span class="o">-</span><span class="p">(</span><span class="n">length_of_filters</span><span class="p">):,:,:,:]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_init</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">OPLLayerNode</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">make_nd</span><span class="p">(</span><span class="n">I_OPL</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span><span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="OPLAllRecursive"><a class="viewcode-back" href="../../../retina.html#convis.filters.retina.OPLAllRecursive">[docs]</a><span class="k">class</span> <span class="nc">OPLAllRecursive</span><span class="p">(</span><span class="n">Layer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The OPL current is a filtered version of the luminance input with spatial and temporal kernels.</span>

<span class="sd">    The inputs of the function are: </span>

<span class="sd">     * :py:obj:`L` (the luminance input), </span>
<span class="sd">     * :py:obj:`lambda_OPL`, :py:obj:`w_OPL` (scaling and weight parameters)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">model</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="p">{},</span><span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">input_variable</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">inputs</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">retina</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_variable</span> <span class="o">=</span> <span class="n">make_nd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">create_input</span><span class="p">(),</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">padding</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_input_init</span> <span class="o">=</span> <span class="n">as_state</span><span class="p">(</span><span class="n">dtensor5</span><span class="p">(</span><span class="s1">&#39;input_init&#39;</span><span class="p">),</span>
                                    <span class="n">init</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">padding</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span>
        <span class="n">input_padded_in_time</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_input_init</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">input_variable</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Nx</span> <span class="o">=</span> <span class="mi">10</span><span class="c1">#self._G_C.shape[3]-1 + self._G_S.shape[3]-1</span>
        <span class="n">Ny</span> <span class="o">=</span> <span class="mi">10</span><span class="c1">#self._G_C.shape[4]-1 + self._G_S.shape[4]-1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_L</span> <span class="o">=</span> <span class="n">pad5</span><span class="p">(</span><span class="n">pad5</span><span class="p">(</span><span class="n">input_padded_in_time</span><span class="p">,</span><span class="n">Nx</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">Ny</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lambda_OPL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_parameter</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">value_from_config</span><span class="p">())</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;retina.input-luminosity-range&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;input-luminosity-range&#39;</span><span class="p">,</span><span class="mf">255.0</span><span class="p">))),</span>
                <span class="n">save</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">value_to_config</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;retina.input-luminosity-range&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;input-luminosity-range&#39;</span><span class="p">,</span><span class="mf">255.0</span><span class="p">)))</span> <span class="o">*</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">get_value</span><span class="p">()))),</span>
                <span class="n">get</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;retina.input-luminosity-range&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;input-luminosity-range&#39;</span><span class="p">,</span><span class="mf">255.0</span><span class="p">)))</span> <span class="o">*</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">get_value</span><span class="p">())),</span>
                <span class="n">config_key</span> <span class="o">=</span> <span class="s1">&#39;opl-amplification&#39;</span><span class="p">,</span>
                <span class="n">config_default</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;lambda_OPL&#39;</span><span class="p">,</span>
                <span class="n">doc</span><span class="o">=</span><span class="s1">&#39;Gain applied to the OPL signal.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_w_OPL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_parameter</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;opl-relative-weight&#39;</span><span class="p">,</span><span class="mf">1.0</span><span class="p">,</span><span class="nb">float</span><span class="p">),</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;w_OPL&#39;</span><span class="p">)</span>
        <span class="n">I_OPL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lambda_OPL</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_L</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_w_OPL</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_L</span><span class="p">)</span>

        <span class="n">as_out_state</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">set_subtensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_init</span><span class="p">[:,</span><span class="o">-</span><span class="p">(</span><span class="n">input_padded_in_time</span><span class="p">[:,</span><span class="o">-</span><span class="p">(</span><span class="n">padding</span><span class="p">[</span><span class="mi">0</span><span class="p">]):,:,:,:]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):,:,:,:],</span>
                                    <span class="n">input_padded_in_time</span><span class="p">[:,</span><span class="o">-</span><span class="p">(</span><span class="n">padding</span><span class="p">[</span><span class="mi">0</span><span class="p">]):,:,:,:]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_init</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">OPLAllRecursive</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">make_nd</span><span class="p">(</span><span class="n">I_OPL</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span><span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="OPLLayerLeakyHeatNode"><a class="viewcode-back" href="../../../retina.html#convis.filters.retina.OPLLayerLeakyHeatNode">[docs]</a><span class="k">class</span> <span class="nc">OPLLayerLeakyHeatNode</span><span class="p">(</span><span class="n">Layer</span><span class="p">):</span>        
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The OPL current is a filtered version of the luminance input with spatial and temporal kernels.</span>

<span class="sd">    $$I_{OLP}(x,y,t) = \lambda_{OPL}(C(x,y,t) - w_{OPL} S(x,y,t)_)$$</span>

<span class="sd">    with:</span>

<span class="sd">    :math:`C(x,y,t) = G * T(wu,Tu) * E(n,t) * L (x,y,t)`</span>

<span class="sd">    :math:`S(x,y,t) = G * E * C(x,y,t)`</span>

<span class="sd">    In the case of leaky heat equation:</span>

<span class="sd">    :math:`C(x,y,t) = T(wu,Tu) * K(sigma_C,Tau_C) * L (x,y,t)`</span>

<span class="sd">    :math:`S(x,y,t) = K(sigma_S,Tau_S) * C(x,y,t)`</span>
<span class="sd">    p.275</span>

<span class="sd">    To keep all dimensions similar, a *fake kernel* has to be used on the center output that contains a single 1 but has the shape of the filters used on the surround, such that the surround can be subtracted from the center.</span>

<span class="sd">    The inputs of the function are: </span>

<span class="sd">     * :py:obj:`L` (the luminance input), </span>
<span class="sd">     * :py:obj:`E_n_C`, :py:obj:`TwuTu_C`, :py:obj:`G_C` (the center filters), </span>
<span class="sd">     * :py:obj:`E_S`, :py:obj:`G_S` (the surround filters), </span>
<span class="sd">     * :py:obj:`Reshape_C_S` (the fake filter), </span>
<span class="sd">     * :py:obj:`lambda_OPL`, :py:obj:`w_OPL` (scaling and weight parameters)</span>

<span class="sd">    Since we want to have some temporal and some spatial convolutions (some 1d, some 2d, but orthogonal to each other), we have to use 3d convolution (we don&#39;t have to, but this way we never have to worry about which is which axis). 3d convolution uses 5-tensors (see: &lt;a href=&quot;http://deeplearning.net/software/theano/library/tensor/nnet/conv.html#theano.tensor.nnet.conv3d2d.conv3d&quot;&gt;theano.tensor.nnet.conv&lt;/a&gt;), so we define all inputs, kernels and outputs to be 5-tensors with the unused dimensions (color channels and batch/kernel number) set to be length 1.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="p">{},</span><span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">model</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">inputs</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        
        <span class="c1"># center</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">retina</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_variable</span> <span class="o">=</span> <span class="n">make_nd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">create_input</span><span class="p">(),</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_E_n_C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_parameter</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">exponential_filter_5d</span><span class="p">(</span><span class="n">tau</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;center-tau__sec&#39;</span><span class="p">,</span><span class="mf">0.01</span><span class="p">)),</span>
                                            <span class="n">n</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;center-n__uint&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
                                            <span class="n">resolution</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">resolution</span><span class="p">),</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;E_n_C&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_TwuTu_C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_parameter</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">exponential_highpass_filter_5d</span><span class="p">(</span><span class="n">tau</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;undershoot&#39;</span><span class="p">,{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tau__sec&#39;</span><span class="p">,</span><span class="mf">0.1</span><span class="p">)),</span>
                                                     <span class="n">relative_weight</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;undershoot&#39;</span><span class="p">,{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;relative-weight&#39;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)),</span>
                                                     <span class="n">resolution</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">resolution</span><span class="p">),</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;TwuTu_C&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_G_C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_parameter</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">gauss_filter_5d</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;center-sigma__deg&#39;</span><span class="p">,</span><span class="mf">0.05</span><span class="p">)),</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;center-sigma__deg&#39;</span><span class="p">,</span><span class="mf">0.05</span><span class="p">)),</span>
                                      <span class="n">resolution</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">resolution</span><span class="p">,</span><span class="n">even</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;G_C&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_G_S</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_parameter</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">gauss_filter_2d</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;surround-sigma__deg&#39;</span><span class="p">,</span><span class="mf">0.15</span><span class="p">)),</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;surround-sigma__deg&#39;</span><span class="p">,</span><span class="mf">0.15</span><span class="p">)),</span>
                                      <span class="n">resolution</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">resolution</span><span class="p">,</span><span class="n">even</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;G_S&#39;</span><span class="p">)</span>
        <span class="c1">#self._lambda_OPL = self.shared_parameter(</span>
        <span class="c1">#    lambda x: x.get_config(&#39;opl-amplification&#39;,10.0,float) / float(x.model.config.get(&#39;input-luminosity-range&#39;,255.0)),name=&#39;lambda_OPL&#39;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lambda_OPL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_parameter</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">value_from_config</span><span class="p">())</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;retina.input-luminosity-range&#39;</span><span class="p">,</span><span class="mf">255.0</span><span class="p">)),</span>
                <span class="n">save</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">value_to_config</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;retina.input-luminosity-range&#39;</span><span class="p">,</span><span class="mf">255.0</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">get_value</span><span class="p">()))),</span>
                <span class="n">get</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;retina.input-luminosity-range&#39;</span><span class="p">,</span><span class="mf">255.0</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">get_value</span><span class="p">())),</span>
                <span class="n">config_key</span> <span class="o">=</span> <span class="s1">&#39;opl-amplification&#39;</span><span class="p">,</span>
                <span class="n">config_default</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;lambda_OPL&#39;</span><span class="p">,</span>
                <span class="n">doc</span><span class="o">=</span><span class="s1">&#39;Gain applied to the OPL signal.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_w_OPL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_parameter</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;opl-relative-weight&#39;</span><span class="p">,</span><span class="mf">1.0</span><span class="p">,</span><span class="nb">float</span><span class="p">),</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;w_OPL&#39;</span><span class="p">,</span>
                <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Weight applied to the surround signal.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_input_init</span> <span class="o">=</span> <span class="n">as_state</span><span class="p">(</span><span class="n">dtensor5</span><span class="p">(</span><span class="s1">&#39;input_init&#39;</span><span class="p">),</span>
                                    <span class="n">init</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">get_convis_attribute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_E_n_C</span><span class="p">,</span><span class="s1">&#39;update&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
                                                             <span class="o">+</span> <span class="n">get_convis_attribute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_TwuTu_C</span><span class="p">,</span><span class="s1">&#39;update&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                                    <span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span>
        <span class="n">input_padded_in_time</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_input_init</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">input_variable</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Nx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_G_C</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">Ny</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_G_C</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_L</span> <span class="o">=</span> <span class="n">pad5</span><span class="p">(</span><span class="n">pad5</span><span class="p">(</span><span class="n">input_padded_in_time</span><span class="p">,</span><span class="n">Nx</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">Ny</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_C</span> <span class="o">=</span> <span class="n">GraphWrapper</span><span class="p">(</span><span class="n">make_nd</span><span class="p">(</span><span class="n">conv3d</span><span class="p">(</span><span class="n">conv3d</span><span class="p">(</span><span class="n">conv3d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_L</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_E_n_C</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">_TwuTu_C</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">_G_C</span><span class="p">),</span><span class="mi">3</span><span class="p">),</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">graph</span>
        
        <span class="c1"># surround</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="n">as_parameter</span><span class="p">(</span><span class="n">theano</span><span class="o">.</span><span class="n">shared</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;surround-tau__sec&#39;</span><span class="p">,</span><span class="mf">0.001</span><span class="p">))),</span>
                           <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;tau__sec&#39;</span><span class="p">,</span>
                           <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;$</span><span class="se">\\</span><span class="s2">tau$ gives the time constant of the exponential decay in seconds.</span>
<span class="s2">                           Small values give fast responses while large values give slow responses.</span>
<span class="s2">                           The steps to seconds conversion of the associated model will be used to compute.</span>

<span class="s2">                           The default value is 10ms.</span>
<span class="s2">                           &quot;&quot;&quot;</span><span class="p">,</span>
                           <span class="n">initialized</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
                           <span class="n">optimizable</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
                           <span class="n">config_key</span> <span class="o">=</span> <span class="s1">&#39;surround-tau__sec&#39;</span><span class="p">,</span>
                           <span class="n">init</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;surround-tau__sec&#39;</span><span class="p">,</span><span class="mf">0.001</span><span class="p">)))</span>
        <span class="n">steps</span> <span class="o">=</span> <span class="n">as_parameter</span><span class="p">(</span><span class="n">theano</span><span class="o">.</span><span class="n">shared</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">steps_to_seconds</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)),</span>
                            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;step&#39;</span><span class="p">,</span>
                            <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;To convert the time constant in seconds into the appropriate length in bins or steps, this value will be automatically filled via the associatated model.&quot;&quot;&quot;</span><span class="p">,</span>
                            <span class="n">initialized</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> 
                            <span class="n">init</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">resolution</span><span class="o">.</span><span class="n">steps_to_seconds</span><span class="p">(</span><span class="mf">1.0</span><span class="p">))</span>
        <span class="n">_preceding_V</span> <span class="o">=</span> <span class="n">as_state</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">dmatrix</span><span class="p">(</span><span class="s2">&quot;preceding_V&quot;</span><span class="p">),</span>
                               <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Since recursive filtering needs the result of the previous timestep, the last time step has to be remembered as a state inbetween computations.&quot;</span><span class="p">,</span>
                               <span class="n">init</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;initial_value&#39;</span><span class="p">,</span><span class="mf">0.5</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:]))</span> <span class="c1"># initial condition for sequence</span>
        <span class="n">_preceding_input</span> <span class="o">=</span> <span class="n">as_state</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">dmatrix</span><span class="p">(</span><span class="s2">&quot;preceding_input&quot;</span><span class="p">),</span>
                               <span class="n">init</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;initial_value&#39;</span><span class="p">,</span><span class="mf">0.5</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:]))</span> <span class="c1"># initial condition for sequence</span>
        <span class="n">a_0</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">a_1</span> <span class="o">=</span> <span class="o">-</span><span class="n">T</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">steps</span><span class="o">/</span><span class="n">tau</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a_1</span> <span class="o">=</span> <span class="n">a_1</span>
        <span class="n">b_0</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">a_1</span>
        <span class="n">_k</span> <span class="o">=</span> <span class="n">as_parameter</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">iscalar</span><span class="p">(</span><span class="s2">&quot;k&quot;</span><span class="p">),</span><span class="n">init</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># number of iteration steps</span>

        <span class="c1">## radial blur</span>
        <span class="n">dtensor4_broadcastable</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">TensorType</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">,</span> <span class="p">(</span><span class="bp">False</span><span class="p">,</span><span class="bp">False</span><span class="p">,</span><span class="bp">False</span><span class="p">,</span><span class="bp">True</span><span class="p">))</span>
        <span class="n">dtensor3_broadcastable</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">TensorType</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">,</span> <span class="p">(</span><span class="bp">False</span><span class="p">,</span><span class="bp">False</span><span class="p">,</span><span class="bp">True</span><span class="p">))</span>

        <span class="n">kernel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_G_S</span>
        
        <span class="k">def</span> <span class="nf">filter_step</span><span class="p">(</span><span class="n">input_image</span><span class="p">,</span>
                        <span class="n">preceding_V</span><span class="p">,</span><span class="n">preceding_input</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                This function computes a single frame for the recursive exponential filtering.</span>

<span class="sd">                Additionally, in each step the output is smoothed with a kernel, such that</span>
<span class="sd">                activity propagates across the entire population (if given enough time).</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1">#V = input_image - 0.1*(preceding_input * b_0 - preceding_V * a_1) / a_0</span>
            <span class="c1">#V = preceding_V + input_image# + 0.01*(preceding_input * b_0 - preceding_V * a_1) / a_0</span>
            <span class="n">V</span> <span class="o">=</span> <span class="p">(</span><span class="n">input_image</span> <span class="o">*</span> <span class="n">b_0</span> <span class="o">-</span> <span class="n">preceding_V</span> <span class="o">*</span> <span class="n">a_1</span><span class="p">)</span> <span class="o">/</span> <span class="n">a_0</span>

            <span class="n">s0</span> <span class="o">=</span> <span class="p">(</span><span class="n">kernel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
            <span class="n">s0</span> <span class="o">=</span> <span class="p">(</span><span class="n">kernel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">s1</span> <span class="o">=</span> <span class="p">(</span><span class="n">kernel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
            <span class="n">s1</span> <span class="o">=</span> <span class="p">(</span><span class="n">kernel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
            <span class="c1">#V_padded = make_nd(pad5(pad5(make_nd(V,5),s0,3,mode = &#39;const&#39;,c=T.mean(V)),s1,4,mode = &#39;const&#39;,c=T.mean(V)),2)</span>
            <span class="c1">#V_padded = make_nd(pad5(pad5(make_nd(V,5),s0,3,mode = &#39;mirror&#39;),s1,4,mode = &#39;mirror&#39;),2)</span>
            <span class="n">V_padded</span> <span class="o">=</span> <span class="n">pad2_xy</span><span class="p">(</span><span class="n">V</span><span class="p">,</span><span class="n">s0</span><span class="p">,</span><span class="n">s1</span><span class="p">,</span><span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;mirror&#39;</span><span class="p">)</span>
            <span class="n">s0begin</span> <span class="o">=</span> <span class="p">(</span><span class="n">kernel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span> <span class="o">+</span> <span class="n">s0</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">s1begin</span> <span class="o">=</span> <span class="p">(</span><span class="n">kernel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span> <span class="o">+</span> <span class="n">s1</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">s0end</span> <span class="o">=</span> <span class="n">V</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">s0begin</span>
            <span class="n">s1end</span> <span class="o">=</span> <span class="n">V</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">s1begin</span>
            <span class="n">V_smoothed</span> <span class="o">=</span> <span class="n">conv2d</span><span class="p">(</span><span class="n">V_padded</span><span class="p">,</span><span class="n">kernel</span><span class="p">,</span> <span class="n">border_mode</span><span class="o">=</span><span class="s1">&#39;full&#39;</span><span class="p">)[</span><span class="n">s0begin</span><span class="p">:</span><span class="n">s0end</span><span class="p">,</span><span class="n">s1begin</span><span class="p">:</span><span class="n">s1end</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">V_smoothed</span><span class="p">,</span><span class="n">input_image</span>
        
        <span class="n">output_variable</span><span class="p">,</span> <span class="n">_updates</span> <span class="o">=</span> <span class="n">theano</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">fn</span><span class="o">=</span><span class="n">filter_step</span><span class="p">,</span>
                                      <span class="n">outputs_info</span><span class="o">=</span><span class="p">[</span><span class="n">_preceding_V</span><span class="p">,</span><span class="n">_preceding_input</span><span class="p">],</span>
                                      <span class="n">sequences</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_C</span><span class="p">],</span>
                                      <span class="n">non_sequences</span><span class="o">=</span><span class="p">[],</span>
                                      <span class="n">n_steps</span><span class="o">=</span><span class="n">_k</span><span class="p">)</span>
        <span class="n">set_convis_attribute</span><span class="p">(</span><span class="n">output_variable</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;output&#39;</span><span class="p">)</span>
        <span class="n">as_out_state</span><span class="p">(</span><span class="n">output_variable</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">_preceding_V</span><span class="p">)</span>
        <span class="n">as_out_state</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_C</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">_preceding_input</span><span class="p">)</span>
        <span class="n">surround_out</span> <span class="o">=</span> <span class="n">GraphWrapper</span><span class="p">(</span><span class="n">output_variable</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;surround&#39;</span><span class="p">,</span><span class="n">ignore</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_C</span><span class="p">])</span><span class="o">.</span><span class="n">graph</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_S</span> <span class="o">=</span> <span class="n">surround_out</span>
        <span class="n">I_OPL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lambda_OPL</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_C</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_w_OPL</span> <span class="o">*</span> <span class="n">surround_out</span><span class="p">)</span>
        
        <span class="n">length_of_filters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_E_n_C</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_TwuTu_C</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">as_out_state</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">set_subtensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_init</span><span class="p">[:,</span><span class="o">-</span><span class="p">(</span><span class="n">input_padded_in_time</span><span class="p">[:,</span><span class="o">-</span><span class="p">(</span><span class="n">length_of_filters</span><span class="p">):,:,:,:]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):,:,:,:],</span>
                                    <span class="n">input_padded_in_time</span><span class="p">[:,</span><span class="o">-</span><span class="p">(</span><span class="n">length_of_filters</span><span class="p">):,:,:,:]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_init</span><span class="p">)</span>
        
        <span class="nb">super</span><span class="p">(</span><span class="n">OPLLayerLeakyHeatNode</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">I_OPL</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span><span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_type</span> <span class="o">=</span> <span class="s1">&#39;OPL Layer LeakyHeat Node&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_description</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="s1">&#39;Temporal Recursive Filtering and Spatial Convolution&#39;</span>

 </div>
<div class="viewcode-block" id="BipolarLayerNode"><a class="viewcode-back" href="../../../retina.html#convis.filters.retina.BipolarLayerNode">[docs]</a><span class="k">class</span> <span class="nc">BipolarLayerNode</span><span class="p">(</span><span class="n">Layer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Example Configuration::</span>

<span class="sd">        &#39;contrast-gain-control&#39;: {</span>
<span class="sd">            &#39;opl-amplification__Hz&#39;: 50, # for linear OPL: ampOPL = relative_ampOPL / fatherRetina-&gt;input_luminosity_range ;</span>
<span class="sd">                                                       # `ampInputCurrent` in virtual retina</span>
<span class="sd">            &#39;bipolar-inert-leaks__Hz&#39;: 50,             # `gLeak` in virtual retina</span>
<span class="sd">            &#39;adaptation-sigma__deg&#39;: 0.2,              # `sigmaSurround` in virtual retina</span>
<span class="sd">            &#39;adaptation-tau__sec&#39;: 0.005,              # `tauSurround` in virtual retina</span>
<span class="sd">            &#39;adaptation-feedback-amplification__Hz&#39;: 0 # `ampFeedback` in virtual retina</span>
<span class="sd">        },</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">model</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">input_variable</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">inputs</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">retina</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>
        <span class="c1"># Rewrite with the following assumptions:</span>
        <span class="c1">## controlCond_a is always two elements: a_0, a_1</span>
        <span class="c1">## controlCond_b is always one element: b_0</span>
        <span class="c1"># we only need to remember one slice of last input to the inhibitory controlCond</span>
        <span class="c1"># we only need to remember one slice of values from the previous timestep</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_lambda_amp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_parameter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;adaptation-feedback-amplification__Hz&#39;</span><span class="p">,</span><span class="mi">50</span><span class="p">)),</span>
                                                 <span class="n">name</span><span class="o">=</span><span class="s2">&quot;lambda_amp&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_g_leak</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_parameter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bipolar-inert-leaks__Hz&#39;</span><span class="p">,</span><span class="mi">50</span><span class="p">)),</span>
                                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;g_leak&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_input_amp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_parameter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;opl-amplification__Hz&#39;</span><span class="p">,</span><span class="mi">100</span><span class="p">)),</span>
                                       <span class="n">name</span><span class="o">=</span><span class="s2">&quot;input_amp&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inputNernst_inhibition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_parameter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;inhibition_nernst&#39;</span><span class="p">,</span><span class="mf">0.0</span><span class="p">)),</span>
                                                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;inputNernst_inhibition&quot;</span><span class="p">)</span>

        <span class="n">tau</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_parameter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">resolution</span><span class="o">.</span><span class="n">seconds_to_steps</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;adaptation-tau__sec&#39;</span><span class="p">,</span><span class="mf">0.00001</span><span class="p">))),</span>
                           <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;tau&#39;</span><span class="p">)</span>
        <span class="n">steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_parameter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">resolution</span><span class="o">.</span><span class="n">steps_to_seconds</span><span class="p">(</span><span class="mf">1.0</span><span class="p">),</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;step&#39;</span><span class="p">)</span>
        <span class="n">a_0</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">a_1</span> <span class="o">=</span> <span class="o">-</span><span class="n">T</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">steps</span><span class="o">/</span><span class="n">tau</span><span class="p">)</span>
        <span class="n">b_0</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">a_1</span>
        <span class="c1"># definition of sequences / initial condition for sequences</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_I_OPL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_input</span><span class="p">()</span> <span class="c1">#sequence</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_preceding_V_bip</span> <span class="o">=</span> <span class="n">as_state</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">dmatrix</span><span class="p">(</span><span class="s2">&quot;preceding_V_bip&quot;</span><span class="p">),</span>
            <span class="n">init</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;initial_value&#39;</span><span class="p">,</span><span class="mf">0.5</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:]))</span> <span class="c1"># initial condition for sequence</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_preceding_inhibition</span> <span class="o">=</span> <span class="n">as_state</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">dmatrix</span><span class="p">(</span><span class="s2">&quot;preceding_inhibition&quot;</span><span class="p">),</span>
            <span class="n">init</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;initial_value&#39;</span><span class="p">,</span><span class="mf">0.5</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:]))</span> <span class="c1"># initial condition for sequence</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inhibition_smoothing_kernel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_parameter</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">gauss_filter_2d</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;adaptation-sigma__deg&#39;</span><span class="p">,</span><span class="mf">0.2</span><span class="p">)),</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;adaptation-sigma__deg&#39;</span><span class="p">,</span><span class="mf">0.2</span><span class="p">)),</span>
                                      <span class="n">resolution</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">resolution</span><span class="p">,</span><span class="n">even</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;inhibition_smoothing_kernel&#39;</span><span class="p">)</span>
                <span class="c1">#T.dmatrix(self.name+&quot;_inhibition_smoothing_kernel&quot;) # initial condition for sequence</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_k_bip</span> <span class="o">=</span> <span class="n">as_parameter</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">iscalar</span><span class="p">(</span><span class="s2">&quot;k&quot;</span><span class="p">),</span><span class="n">init</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># number of iteration steps</span>

        <span class="c1"># Definition of bipolar computations in an iterative loop</span>
        <span class="c1">#    compare with the implementation in python for a version</span>
        <span class="c1">#    that is closer to virtual retina.</span>
        <span class="c1">#</span>
        <span class="c1"># The simulation has two populations of neurons, each being the size of the input image.</span>
        <span class="c1"># `V_bip` is the output of this stage and the excitatory population (called `daValues` in VR)</span>
        <span class="c1">#   `V_bip` recieves current input through `input_image` and conductance input through `preceding_inhibition`</span>
        <span class="c1"># `inhibition` is the inhibitory population (`controlCond` in VR)</span>
        <span class="c1">#   it gets a E and G filtered version of the rectified V_bip</span>
        <span class="c1">#</span>
        <span class="c1"># The `attenuation_map` provides a different conductance for each pixel </span>
        <span class="c1">#    it is calculated from the previous time steps `inhibition` value</span>
        <span class="c1">#    which in turn is a filtered version of the rectified `V_bip`.</span>
        <span class="c1"># The shape of the rectification is controlled by `g_leak` and `lambda_amp`</span>
        <span class="k">def</span> <span class="nf">bipolar_step</span><span class="p">(</span><span class="n">input_image</span><span class="p">,</span>
                        <span class="n">preceding_V_bip</span><span class="p">,</span> <span class="n">preceding_attenuationMap</span><span class="p">,</span> <span class="n">preceding_inhibition</span><span class="p">,</span> 
                        <span class="n">lambda_amp</span><span class="p">,</span> <span class="n">g_leak</span><span class="p">,</span> <span class="n">input_amp</span><span class="p">,</span><span class="n">inputNernst_inhibition</span><span class="p">,</span><span class="n">inhibition_smoothing_kernel</span><span class="p">):</span>
                        <span class="c1"># note: preceding_attenuationMap is not used: this is only an output</span>
            <span class="n">total_conductance</span> <span class="o">=</span> <span class="n">as_variable</span><span class="p">(</span><span class="n">g_leak</span> <span class="o">+</span> <span class="n">as_variable</span><span class="p">(</span><span class="n">preceding_inhibition</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;preceding_inhibition&#39;</span><span class="p">),</span><span class="s1">&#39;total_conductance&#39;</span><span class="p">)</span>
            <span class="n">attenuation_map</span> <span class="o">=</span> <span class="n">as_variable</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">steps</span><span class="o">*</span><span class="n">total_conductance</span><span class="p">),</span><span class="s1">&#39;attenuation map&#39;</span><span class="p">)</span>
            <span class="n">E_infinity</span> <span class="o">=</span> <span class="n">as_variable</span><span class="p">((</span><span class="n">input_amp</span> <span class="o">*</span> <span class="n">as_variable</span><span class="p">(</span><span class="n">input_image</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;input_image&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">inputNernst_inhibition</span> <span class="o">*</span> <span class="n">preceding_inhibition</span><span class="p">)</span><span class="o">/</span><span class="n">total_conductance</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;E_infinity&#39;</span><span class="p">)</span>
            <span class="n">V_bip</span> <span class="o">=</span> <span class="n">as_variable</span><span class="p">(((</span><span class="n">preceding_V_bip</span> <span class="o">-</span> <span class="n">E_infinity</span><span class="p">)</span> <span class="o">*</span> <span class="n">attenuation_map</span><span class="p">)</span> <span class="o">+</span> <span class="n">E_infinity</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;V_bip&#39;</span><span class="p">)</span> <span class="c1"># V_bip converges to E_infinity</span>
            
            <span class="n">s0</span> <span class="o">=</span> <span class="p">(</span><span class="n">inhibition_smoothing_kernel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
            <span class="n">s0end</span> <span class="o">=</span> <span class="n">preceding_V_bip</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">s0</span>
            <span class="n">s1</span> <span class="o">=</span> <span class="p">(</span><span class="n">inhibition_smoothing_kernel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
            <span class="n">s1end</span> <span class="o">=</span> <span class="n">preceding_V_bip</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">s1</span>
            <span class="n">inhibition</span> <span class="o">=</span> <span class="n">as_variable</span><span class="p">((</span><span class="n">conv2d</span><span class="p">((</span><span class="n">lambda_amp</span><span class="o">*</span><span class="p">(</span><span class="n">preceding_V_bip</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">b_0</span> 
                                       <span class="o">-</span> <span class="n">preceding_inhibition</span> <span class="o">*</span> <span class="n">a_1</span><span class="p">)</span> <span class="o">/</span> <span class="n">a_0</span><span class="p">,</span> <span class="n">inhibition_smoothing_kernel</span><span class="p">,</span> <span class="n">border_mode</span><span class="o">=</span><span class="s1">&#39;full&#39;</span><span class="p">)[</span><span class="n">s0</span><span class="p">:</span><span class="n">s0end</span><span class="p">,</span><span class="n">s1</span><span class="p">:</span><span class="n">s1end</span><span class="p">]),</span><span class="s1">&#39;smoothed_inhibition&#39;</span><span class="p">)</span>
            <span class="c1"># // # missing feature from Virtual Retina:</span>
            <span class="c1"># // ##if(gCoupling!=0)</span>
            <span class="c1"># // ##  leakyHeatFilter.radiallyVariantBlur( *targets ); //last_values...</span>

            <span class="k">return</span> <span class="p">[</span><span class="n">V_bip</span><span class="p">,</span><span class="n">attenuation_map</span><span class="p">,</span><span class="n">inhibition</span><span class="p">]</span>

        <span class="c1"># The order in theano.scan has to match the order of arguments in the function bipolar_step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_result</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_updates</span> <span class="o">=</span> <span class="n">theano</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">fn</span><span class="o">=</span><span class="n">bipolar_step</span><span class="p">,</span>
                                      <span class="n">outputs_info</span><span class="o">=</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">_preceding_V_bip</span><span class="p">),</span><span class="n">T</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_preceding_V_bip</span><span class="p">),(</span><span class="bp">self</span><span class="o">.</span><span class="n">_preceding_inhibition</span><span class="p">)],</span>
                                      <span class="n">sequences</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_I_OPL</span><span class="p">],</span>
                                      <span class="n">non_sequences</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_lambda_amp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_g_leak</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_amp</span><span class="p">,</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">_inputNernst_inhibition</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inhibition_smoothing_kernel</span><span class="p">],</span>
                                      <span class="n">n_steps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_I_OPL</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="c1">#self._k_bip)</span>
        <span class="n">as_out_state</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">_preceding_V_bip</span><span class="p">)</span>
        <span class="c1"># attenuation is not part of the state, but can be used as an output sequence</span>
        <span class="n">as_out_state</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_result</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">_preceding_inhibition</span><span class="p">)</span>
        <span class="c1">## The order of arguments presented here is arbitrary (will be inferred by the symbols provided),</span>
        <span class="c1">##  but function calls to compute_V_bip have to match this order!</span>
        <span class="c1">#self.compute_V_bip = theano.function(inputs=[self._I_OPL,self._preceding_V_bip,self._preceding_inhibition,</span>
        <span class="c1">#                                              self._lambda_amp, self._g_leak, self._step_size, self._input_amp,</span>
        <span class="c1">#                                              self._inputNernst_inhibition, self._inhibition_smoothing_kernel, self._b_0, self._a_0, self._a_1,</span>
        <span class="c1">#                                              self._k_bip], </span>
        <span class="c1">#                                      outputs=self._result, </span>
        <span class="c1">#                                      updates=self._updates)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">BipolarLayerNode</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">make_nd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_result</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">3</span><span class="p">),</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span><span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="GanglionInputLayerNode"><a class="viewcode-back" href="../../../retina.html#convis.filters.retina.GanglionInputLayerNode">[docs]</a><span class="k">class</span> <span class="nc">GanglionInputLayerNode</span><span class="p">(</span><span class="n">Layer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The input current to the ganglion cells is filtered through a gain function.</span>

<span class="sd">    :math:`I_{Gang}(x,y,t) = G * N(eT * V_{Bip})`</span>


<span class="sd">    :math:`N(V) = \\frac{i^0_G}{1-\lambda(V-v^0_G)/i^0_G}` (if :math:`V &lt; v^0_G`)</span>

<span class="sd">    </span>
<span class="sd">    :math:`N(V) = i^0_G + \lambda(V-v^0_G)` (if :math:`V &gt; v^0_G`)</span>

<span class="sd">        Example configuration:</span>

<span class="sd">            {</span>
<span class="sd">                &#39;name&#39;: &#39;Parvocellular Off&#39;,</span>
<span class="sd">                &#39;enabled&#39;: True,</span>
<span class="sd">                &#39;sign&#39;: -1,</span>
<span class="sd">                &#39;transient-tau__sec&#39;:0.02,</span>
<span class="sd">                &#39;transient-relative-weight&#39;:0.7,</span>
<span class="sd">                &#39;bipolar-linear-threshold&#39;:0,</span>
<span class="sd">                &#39;value-at-linear-threshold__Hz&#39;:37,</span>
<span class="sd">                &#39;bipolar-amplification__Hz&#39;:100,</span>
<span class="sd">                &#39;sigma-pool__deg&#39;: 0.0,</span>
<span class="sd">                &#39;spiking-channel&#39;: {</span>
<span class="sd">                    ...</span>
<span class="sd">                }</span>
<span class="sd">            },</span>
<span class="sd">            {</span>
<span class="sd">                &#39;name&#39;: &#39;Magnocellular On&#39;,</span>
<span class="sd">                &#39;enabled&#39;: False,</span>
<span class="sd">                &#39;sign&#39;: 1,</span>
<span class="sd">                &#39;transient-tau__sec&#39;:0.03,</span>
<span class="sd">                &#39;transient-relative-weight&#39;:1.0,</span>
<span class="sd">                &#39;bipolar-linear-threshold&#39;:0,</span>
<span class="sd">                &#39;value-at-linear-threshold__Hz&#39;:80,</span>
<span class="sd">                &#39;bipolar-amplification__Hz&#39;:400,</span>
<span class="sd">                &#39;sigma-pool__deg&#39;: 0.1,</span>
<span class="sd">                &#39;spiking-channel&#39;: {</span>
<span class="sd">                    ...</span>
<span class="sd">                }</span>
<span class="sd">            },</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">model</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">input_variable</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">inputs</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">retina</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_V_bip</span> <span class="o">=</span> <span class="n">make_nd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">create_input</span><span class="p">(),</span><span class="mi">5</span><span class="p">)</span>
        <span class="c1"># TODO: state? what about previous episode? concatenate?</span>
        <span class="c1">#num_V_bip = input.reshape((1,input.shape[0],1,input.shape[1],input.shape[2]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_T_G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_parameter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;sign&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="o">*</span> 
                                                        <span class="n">exponential_highpass_filter_5d</span><span class="p">(</span><span class="n">tau</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;transient-tau__sec&#39;</span><span class="p">,</span><span class="mf">0.04</span><span class="p">)),</span>
                                                            <span class="n">relative_weight</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;transient-relative-weight&#39;</span><span class="p">,</span><span class="mf">0.75</span><span class="p">)),</span>
                                                            <span class="n">resolution</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">resolution</span><span class="p">),</span>
                                     <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;T_G&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_input_init</span> <span class="o">=</span> <span class="n">as_state</span><span class="p">(</span><span class="n">dtensor5</span><span class="p">(</span><span class="s1">&#39;input_init&#39;</span><span class="p">),</span>
                                    <span class="n">init</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">get_convis_attribute</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">_T_G</span><span class="p">,</span><span class="s1">&#39;update&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span>

        <span class="c1">#self._V_bip_padded = T.concatenate([T.zeros((1,self._T_G.shape[1]-1,1,self._V_bip.shape[3],self._V_bip.shape[4])),self._V_bip],axis=1)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_V_bip_padded</span> <span class="o">=</span> <span class="n">as_variable</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_init</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_V_bip</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="s1">&#39;V_bip_padded&#39;</span><span class="p">)</span>

        <span class="n">length_of_filters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_T_G</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">as_out_state</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">set_subtensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_init</span><span class="p">[:,</span><span class="o">-</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_V_bip_padded</span><span class="p">[:,</span><span class="o">-</span><span class="p">(</span><span class="n">length_of_filters</span><span class="p">):,:,:,:]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):,:,:,:],</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_V_bip_padded</span><span class="p">[:,</span><span class="o">-</span><span class="p">(</span><span class="n">length_of_filters</span><span class="p">):,:,:,:]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_init</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_V_bip_E</span> <span class="o">=</span> <span class="n">as_variable</span><span class="p">(</span><span class="n">conv3d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_V_bip_padded</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_T_G</span><span class="p">),</span><span class="s1">&#39;V_bip_E&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_i_0_G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_parameter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;value-at-linear-threshold__Hz&#39;</span><span class="p">,</span><span class="mf">70.0</span><span class="p">)),</span>
                                          <span class="n">name</span><span class="o">=</span><span class="s2">&quot;i_0_G&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_v_0_G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_parameter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;bipolar-linear-threshold&#39;</span><span class="p">,</span><span class="mf">0.0</span><span class="p">)),</span>
                                          <span class="n">name</span><span class="o">=</span><span class="s2">&quot;v_0_G&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lambda_G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_parameter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;bipolar-amplification__Hz&#39;</span><span class="p">,</span><span class="mf">100.0</span><span class="p">)),</span>
                                          <span class="n">name</span><span class="o">=</span><span class="s2">&quot;lambda_G&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_G_gang</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_parameter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">gauss_filter_5d</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;sigma-pool__deg&#39;</span><span class="p">,</span><span class="mf">0.0</span><span class="p">)),</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;sigma-pool__deg&#39;</span><span class="p">,</span><span class="mf">0.0</span><span class="p">)),</span>
                                                                       <span class="n">resolution</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">resolution</span><span class="p">,</span><span class="n">even</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                                        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;G_gang&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_N</span> <span class="o">=</span> <span class="n">GraphWrapper</span><span class="p">(</span><span class="n">as_variable</span><span class="p">(</span><span class="n">theano</span><span class="o">.</span><span class="n">tensor</span><span class="o">.</span><span class="n">switch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_V_bip_E</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_v_0_G</span><span class="p">,</span> 
                                 <span class="n">as_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_i_0_G</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_lambda_G</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_V_bip_E</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_v_0_G</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">_i_0_G</span><span class="p">),</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;N_0&#39;</span><span class="p">,</span><span class="n">html_name</span><span class="o">=</span><span class="s1">&#39;N&lt;sub&gt;V&amp;lt;v0&lt;/sub&gt;&#39;</span><span class="p">),</span>
                                 <span class="n">as_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_i_0_G</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lambda_G</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_V_bip_E</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_v_0_G</span><span class="p">),</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;N_1&#39;</span><span class="p">,</span><span class="n">html_name</span><span class="o">=</span><span class="s1">&#39;N&lt;sub&gt;V&amp;gt;=v0&lt;/sub&gt;&#39;</span><span class="p">)),</span><span class="s1">&#39;N_G_gang&#39;</span><span class="p">,</span>
                        <span class="n">requires</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_lambda_G</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_i_0_G</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_v_0_G</span><span class="p">]),</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;N&#39;</span><span class="p">,</span><span class="n">ignore</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_V_bip_E</span><span class="p">])</span><span class="o">.</span><span class="n">graph</span>

        <span class="c1">#self.compute_N = theano.function([self._V_bip, self._T_G, self._i_0_G, self._v_0_G, self._lambda_G], self._N)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_I_Gang</span> <span class="o">=</span> <span class="n">conv3d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_G_gang</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_variable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_I_Gang</span>
        <span class="c1">#self.compute_I_Gang = theano.function([self._V_bip, self._T_G, self._i_0_G, self._v_0_G, self._lambda_G, self._G_gang], theano.Out(self.output_variable, borrow=True))</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GanglionInputLayerNode</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">make_nd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_I_Gang</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span><span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;[Ganglion Input Node] Shape: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">fake_filter_shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_G_gang</span><span class="o">.</span><span class="n">get_value</span><span class="p">(),</span><span class="bp">self</span><span class="o">.</span><span class="n">_T_G</span><span class="o">.</span><span class="n">get_value</span><span class="p">()))</span>
</div>
<div class="viewcode-block" id="GanglionSpikingLayerNode"><a class="viewcode-back" href="../../../retina.html#convis.filters.retina.GanglionSpikingLayerNode">[docs]</a><span class="k">class</span> <span class="nc">GanglionSpikingLayerNode</span><span class="p">(</span><span class="n">Layer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    **TODO:DONE** ~~The refractory time now working!~~</span>

<span class="sd">    The ganglion cells recieve the gain controlled input and produce spikes. </span>

<span class="sd">    When the cell is not refractory, :math:`V` moves as:</span>

<span class="sd">    $$ \\\\dfrac{ dV_n }{dt} = I_{Gang}(x_n,y_n,t) - g^L V_n(t) + \eta_v(t)$$</span>

<span class="sd">    Otherwise it is set to 0.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">model</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">input_variable</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">inputs</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">retina</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_noise_slice</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_k_gang</span> <span class="o">=</span> <span class="n">as_parameter</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">iscalar</span><span class="p">(</span><span class="s2">&quot;k_gang_spike&quot;</span><span class="p">),</span><span class="n">init</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">doc</span><span class="o">=</span><span class="s1">&#39;Length of the input sequence (set automatically).&#39;</span><span class="p">)</span>
        
        <span class="c1">#obsolete? self._refrac = T.dscalar(name+&quot;refrac&quot;)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">input_variable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_input</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_padding</span> <span class="o">=</span> <span class="n">as_state</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">dtensor3</span><span class="p">(</span><span class="s2">&quot;initial_I&quot;</span><span class="p">),</span> <span class="n">init</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">input</span><span class="p">[:</span><span class="mi">1</span><span class="p">,:,:])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_I_gang</span> <span class="o">=</span> <span class="n">as_variable</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">input_padding</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_variable</span><span class="p">]),</span><span class="s1">&#39;I_gang&#39;</span><span class="p">)</span> <span class="c1"># input</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_initial_refr</span> <span class="o">=</span> <span class="n">as_state</span><span class="p">(</span>
                <span class="n">T</span><span class="o">.</span><span class="n">dmatrix</span><span class="p">(</span><span class="s2">&quot;initial_refr&quot;</span><span class="p">),</span>
                <span class="n">init</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:])</span> 
                        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;random-init&#39;</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">False</span>
                        <span class="k">else</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">resolution</span><span class="o">.</span><span class="n">seconds_to_steps</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;refr-mean__sec&#39;</span><span class="p">,</span><span class="mf">0.0005</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">shape</span><span class="p">)),</span>
                <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Initialization of the refractory times. If `random-init` is `True`, each cell gets a random value between `[0..refr-mean__sec]`&quot;</span>
                <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_V_initial</span> <span class="o">=</span> <span class="n">as_state</span><span class="p">(</span>
                <span class="n">T</span><span class="o">.</span><span class="n">dmatrix</span><span class="p">(</span><span class="s2">&quot;V_initial&quot;</span><span class="p">),</span>
                <span class="n">doc</span><span class="o">=</span><span class="s1">&#39;The initial state of the membrane potential (can be randomized with `random-init`).&#39;</span><span class="p">,</span>
                <span class="n">init</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:])</span>
                                <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;random-init&#39;</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">False</span>
                                <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_refr_sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_parameter</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">resolution</span><span class="o">.</span><span class="n">seconds_to_steps</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">value_from_config</span><span class="p">()))),</span>
                <span class="n">save</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">value_to_config</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">resolution</span><span class="o">.</span><span class="n">steps_to_seconds</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">get_value</span><span class="p">()))),</span>
                <span class="n">get</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">resolution</span><span class="o">.</span><span class="n">steps_to_seconds</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">get_value</span><span class="p">()))),</span>
                <span class="n">config_key</span> <span class="o">=</span> <span class="s1">&#39;refr-stdev__sec&#39;</span><span class="p">,</span>
                <span class="n">config_default</span> <span class="o">=</span> <span class="mf">0.001</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;refr_sigma&#39;</span><span class="p">,</span>
                <span class="n">doc</span><span class="o">=</span><span class="s1">&#39;The standard deviation of the refractory time that is randomly drawn around `refr_mu`&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_refr_mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_parameter</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">resolution</span><span class="o">.</span><span class="n">seconds_to_steps</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">value_from_config</span><span class="p">()))),</span>
                <span class="n">save</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">value_to_config</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">resolution</span><span class="o">.</span><span class="n">steps_to_seconds</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">get_value</span><span class="p">()))),</span>
                <span class="n">get</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">resolution</span><span class="o">.</span><span class="n">steps_to_seconds</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">get_value</span><span class="p">()))),</span>
                <span class="n">config_key</span> <span class="o">=</span> <span class="s1">&#39;refr-mean__sec&#39;</span><span class="p">,</span>
                <span class="n">config_default</span> <span class="o">=</span> <span class="mf">0.000523</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;refr_mu&#39;</span><span class="p">,</span>
                <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;The mean of the distribution of random refractory times (in seconds).&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_g_L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_parameter</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">value_from_config</span><span class="p">()),</span>
                <span class="n">config_key</span> <span class="o">=</span> <span class="s1">&#39;g-leak__Hz&#39;</span><span class="p">,</span>
                <span class="n">config_default</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                <span class="n">doc</span><span class="o">=</span><span class="s1">&#39;Leak current (in Hz or dimensionless firing rate).&#39;</span><span class="p">,</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;g_L&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_raw_noise_gang</span> <span class="o">=</span> <span class="n">as_parameter</span><span class="p">(</span>
                <span class="n">T</span><span class="o">.</span><span class="n">dtensor3</span><span class="p">(</span><span class="s2">&quot;noise_gang&quot;</span><span class="p">),</span>
                <span class="n">init</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span>
                <span class="n">doc</span> <span class="o">=</span><span class="s1">&#39;Random input (will be scaled by sigma-V and refr_stdev). Since the membrane potential already crossed the threshold when we want to draw a refractory period, we can safely use the next sample from this random input without introducing any codependency.&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_noise_state</span> <span class="o">=</span> <span class="n">as_state</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">dtensor3</span><span class="p">(</span><span class="s2">&quot;initial_noise&quot;</span><span class="p">),</span> <span class="n">init</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="o">.</span><span class="n">input</span><span class="p">[:</span><span class="mi">1</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_noise_gang</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_noise_state</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_raw_noise_gang</span><span class="p">])</span> <span class="c1"># we need to remember one noise state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_noise_sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_parameter</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">value_from_config</span><span class="p">())</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">x</span><span class="o">.</span><span class="n">resolution</span><span class="o">.</span><span class="n">seconds_to_steps</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;g-leak__Hz&#39;</span><span class="p">,</span><span class="mi">10</span><span class="p">)))),</span>
                <span class="n">save</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">value_to_config</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">get_value</span><span class="p">())</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">x</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">seconds_to_steps</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;g-leak__Hz&#39;</span><span class="p">,</span><span class="mi">10</span><span class="p">))))),</span>
                <span class="n">get</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">get_value</span><span class="p">())</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">x</span><span class="o">.</span><span class="n">resolution</span><span class="o">.</span><span class="n">seconds_to_steps</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;g-leak__Hz&#39;</span><span class="p">,</span><span class="mi">10</span><span class="p">)))),</span>
                <span class="n">config_key</span> <span class="o">=</span> <span class="s1">&#39;sigma-V&#39;</span><span class="p">,</span>
                <span class="n">config_default</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
                <span class="n">doc</span><span class="o">=</span><span class="s1">&#39;Amount of noise added to the membrane potential.&#39;</span><span class="p">,</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;noise_sigma&quot;</span><span class="p">)</span>

        <span class="c1">#self.random_init = self.config.get(&#39;random-init&#39;,None)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_tau</span> <span class="o">=</span> <span class="n">shared_parameter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">resolution</span><span class="o">.</span><span class="n">steps_to_seconds</span><span class="p">(</span><span class="mf">1.0</span><span class="p">),</span>
                <span class="n">O</span><span class="p">()(</span><span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">),</span>
                <span class="n">doc</span> <span class="o">=</span> <span class="s1">&#39;Length of timesteps (ie. the steps_to_seconds(1.0) of the model.&#39;</span><span class="p">,</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;tau&#39;</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">spikeStep</span><span class="p">(</span><span class="n">I_gang</span><span class="p">,</span> <span class="n">noise_gang</span><span class="p">,</span><span class="n">noise_gang_prev</span><span class="p">,</span>
                      <span class="n">prior_V</span><span class="p">,</span> <span class="n">prior_refr</span><span class="p">,</span>  
                      <span class="n">noise_sigma</span><span class="p">,</span> <span class="n">refr_mu</span><span class="p">,</span> <span class="n">refr_sigma</span><span class="p">,</span> <span class="n">g_L</span><span class="p">,</span><span class="n">tau_gang</span><span class="p">):</span>
            <span class="n">V</span> <span class="o">=</span> <span class="n">prior_V</span> <span class="o">+</span> <span class="p">(</span><span class="n">I_gang</span> <span class="o">-</span> <span class="n">g_L</span> <span class="o">*</span> <span class="n">prior_V</span> <span class="o">+</span> <span class="n">noise_sigma</span><span class="o">*</span><span class="p">(</span><span class="n">noise_gang</span><span class="p">))</span><span class="o">*</span><span class="n">tau_gang</span>
            <span class="n">V</span> <span class="o">=</span> <span class="n">as_variable</span><span class="p">(</span><span class="n">theano</span><span class="o">.</span><span class="n">tensor</span><span class="o">.</span><span class="n">switch</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="n">prior_refr</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">V</span><span class="p">),</span><span class="s1">&#39;V&#39;</span><span class="p">)</span>
            <span class="n">spikes</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="n">refr</span> <span class="o">=</span> <span class="n">as_variable</span><span class="p">(</span><span class="n">theano</span><span class="o">.</span><span class="n">tensor</span><span class="o">.</span><span class="n">switch</span><span class="p">(</span><span class="n">spikes</span><span class="p">,</span>
                    <span class="n">prior_refr</span> <span class="o">+</span> <span class="n">refr_mu</span> <span class="o">+</span> <span class="n">refr_sigma</span> <span class="o">*</span> <span class="n">noise_gang</span><span class="p">,</span>
                    <span class="n">prior_refr</span> <span class="o">-</span> <span class="mf">1.0</span>
                    <span class="p">),</span><span class="s1">&#39;refr&#39;</span><span class="p">)</span>
            <span class="n">next_refr</span> <span class="o">=</span> <span class="n">theano</span><span class="o">.</span><span class="n">tensor</span><span class="o">.</span><span class="n">switch</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="n">refr</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span><span class="mf">0.0</span><span class="p">,</span><span class="n">refr</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">V</span><span class="p">,</span><span class="n">next_refr</span><span class="p">,</span><span class="n">spikes</span><span class="o">*</span><span class="mf">1.0</span><span class="p">]</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_variable</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_result</span><span class="p">,</span> <span class="n">updates</span> <span class="o">=</span> <span class="n">theano</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">fn</span><span class="o">=</span><span class="n">spikeStep</span><span class="p">,</span>
                                      <span class="n">outputs_info</span><span class="o">=</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">_V_initial</span><span class="p">),(</span><span class="bp">self</span><span class="o">.</span><span class="n">_initial_refr</span><span class="p">),</span><span class="bp">None</span><span class="p">],</span>
                                      <span class="n">sequences</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_I_gang</span><span class="p">,</span><span class="nb">dict</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_noise_gang</span><span class="p">,</span> <span class="n">taps</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">])],</span>
                                      <span class="n">non_sequences</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_noise_sigma</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_refr_mu</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_refr_sigma</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_g_L</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tau</span><span class="p">],</span>
                                      <span class="n">n_steps</span><span class="o">=</span><span class="n">k</span><span class="p">)</span><span class="c1">#self._k_gang)</span>
        <span class="n">as_out_state</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_I_gang</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:,:,:],</span><span class="bp">self</span><span class="o">.</span><span class="n">input_padding</span><span class="p">)</span> <span class="c1">#self.input_variable</span>
        <span class="n">as_out_state</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_noise_gang</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:,:,:],</span><span class="bp">self</span><span class="o">.</span><span class="n">_noise_state</span><span class="p">)</span>
        <span class="n">as_out_state</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">_V_initial</span><span class="p">)</span>
        <span class="n">as_out_state</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_result</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">_initial_refr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_V</span> <span class="o">=</span> <span class="n">as_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_result</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;output_V&#39;</span><span class="p">,</span>
            <span class="n">doc</span><span class="o">=</span><span class="s1">&#39;The membrane potential of each unit for each time step.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_refractory</span> <span class="o">=</span> <span class="n">as_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_result</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;output_refractory&#39;</span><span class="p">,</span>
            <span class="n">doc</span><span class="o">=</span><span class="s1">&#39;length of refractory period for each unit until it is allowed to spike again.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_spikes</span> <span class="o">=</span> <span class="n">as_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_result</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;output_spikes&#39;</span><span class="p">,</span>
            <span class="n">doc</span><span class="o">=</span><span class="s1">&#39;Binary count of spikes for each unit for each timestep. The maximal firing rate of this spike generation process is bounded by the size of time bins.&#39;</span><span class="p">)</span>
        <span class="c1">#spikes = T.extra_ops.diff(T.gt(self._result[1],0.0),n=1,axis=0)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GanglionSpikingLayerNode</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_result</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span><span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;[Ganglion Spike Node] Differential Equation&#39;</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">convis 0.1 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2016, Jacob Huth.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.1.
    </div>
  </body>
</html>